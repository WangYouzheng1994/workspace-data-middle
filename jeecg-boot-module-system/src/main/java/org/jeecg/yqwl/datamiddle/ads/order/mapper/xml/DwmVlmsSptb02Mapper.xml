<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.yqwl.datamiddle.ads.order.mapper.DwmVlmsSptb02Mapper">
    <resultMap id="sptb02Result" type="org.jeecg.yqwl.datamiddle.ads.order.entity.DwmVlmsSptb02">
        <result column="TRAFFIC_TYPE" property="trafficType" />
    </resultMap>
    <select id="getSptbTrafficTypeByVin" resultType="org.jeecg.yqwl.datamiddle.ads.order.entity.DwmVlmsSptb02" parameterType="java.util.List" >
        select
               a.TRAFFIC_TYPE as TRAFFIC_TYPE,
               a.VVIN as VVIN,
               a.CJSDBH as CJSDBH,
               a.DSJCFSJ as DSJCFSJ,
               a.DGPSDHSJ as DGPSDHSJ,
                case when (a.TRAFFIC_TYPE = 'G' and(a.DDHSJ != 0 or a.DGPSDHSJ != 0 )) then '已到货'
                when (a.TRAFFIC_TYPE in ('T', 'S') and (a.DDHSJ != 0 or a.DTVSDHSJ != 0)) then '已到货'
                when (a.DCKRQ = 0) then '未出库'
                when (b.NOW_DATE > a.DSJCFSJ and a.TRAFFIC_TYPE = 'G') then b.NOW_ADDRESS || b.NOW_CITY_NAME
                when (c.DCJSJ > a.DSJCFSJ and a.TRAFFIC_TYPE in ('T', 'S')) then c.VWZ
                end VWZ
        from
             dwm_vlms_sptb02 a
        left join ods_vlms_dcs_orders b
        on a.VVIN = b.VIN_NO
        left join ods_vlms_sptb22_dq c
        on a.VJSYDM = c.CPZH
        <where>
            VVIN in
            <foreach item="vin" collection="vins" open="(" separator="," close=")">
                #{vin}
            </foreach>
            and VYSFS != 'J'
        </where>
        order by
            CJSDBH
    </select>

    <!--clickhouse插入数据    -->
    <insert id="insertClickhouse" parameterType="java.util.List" >
        INSERT INTO `default`.dwm_vlms_sptb02(
            CJSDBH,
            DDJRQ,
            ACTUAL_OUT_TIME,
            THEORY_OUT_TIME,
            SHIPMENT_TIME,
            FINAL_SITE_TIME,
            CUSTOMER_NAME,
            BASE_NAME,
            CZJGSDM,
            CQWH)
            VALUES
           <foreach collection="list" item="item" index="index" separator=",">
                   (
                       #{item.CJSDBH},
                       #{item.DDJRQ},
                       #{item.ACTUAL_OUT_TIME},
                       #{item.THEORY_OUT_TIME},
                       #{item.SHIPMENT_TIME},
                       #{item.FINAL_SITE_TIME},
                       #{item.CUSTOMER_NAME},
                       #{item.BASE_NAME},
                       #{item.CZJGSDM},
                       #{item.CQWH}
                    )
           </foreach>
    </insert>
    <!--按条件查询计划量    -->
    <select id="getPlanAmount" parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetBaseBrandTime" resultType="org.jeecg.yqwl.datamiddle.ads.order.entity.ext.ShipmentDTO">
        SELECT
        COUNT(dvs.DDJRQ) as totalNum,
            <choose>
                <when test="params.cqwh != '' and params.czjgsdm == '' ">
                    dvs.CUSTOMER_NAME as groupName,
                </when>
                <otherwise>
                    dvs.BASE_NAME as groupName,
                </otherwise>
            </choose>
        <if test="params.timeType == 'day' ">
            toDate(fromUnixTimestamp64Milli(dvs.DDJRQ))  AS dates
        </if>
        <if test="params.timeType == 'week' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.DDJRQ))),'-',toString(toWeek(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME),9)))   AS dates
        </if>
        <if test="params.timeType == 'month' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.DDJRQ))),'-',toString(toMonth(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))))   AS dates
        </if>
        <if test="params.timeType == 'quarter' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.DDJRQ))),'-',toString(QUARTER(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))))   AS dates
        </if>
        <if test="params.timeType == 'year' ">
            YEAR(fromUnixTimestamp64Milli(dvs.DDJRQ))  AS dates
        </if>
        FROM dwm_vlms_sptb02 dvs
        <where>
            (dvs.CJSDBH, dvs.WAREHOUSE_CREATETIME) in
            (select
                dvs1.CJSDBH,
                max(dvs1.WAREHOUSE_CREATETIME)
            from
            dwm_vlms_sptb02  dvs1
            <where>
                <if test=" params.startTime != null and params.endTime !=null " >
                    and dvs1.DDJRQ BETWEEN  #{params.startTime}and #{params.endTime}
                </if>
                <if test=" params.cqwh != null and params.cqwh != '' ">
                    and dvs1.CQWH = #{params.cqwh}
                </if>
                <if test=" params.czjgsdm != null and params.czjgsdm != '' ">
                    and dvs1.CZJGSDM = #{params.czjgsdm}
                </if>
            </where>
                 group by dvs1.CJSDBH
            )
        </where>
            group by dates,groupName
    </select>
    <!--按条件查询发运量    -->
    <select id="getShipment" parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetBaseBrandTime" resultType="org.jeecg.yqwl.datamiddle.ads.order.entity.ext.ShipmentDTO">
        SELECT
        COUNT(dvs.SHIPMENT_TIME) as totalNum,
        <choose>
            <when test="params.cqwh != '' and params.czjgsdm == '' ">
                dvs.CUSTOMER_NAME as groupName,
            </when>
            <otherwise>
                dvs.BASE_NAME as groupName,
            </otherwise>
        </choose>

        <if test="params.timeType == 'day' ">
            toDate(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))  AS dates
        </if>
        <if test="params.timeType == 'week' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))),'-',toString(toWeek(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME),9)))   AS dates
        </if>
        <if test="params.timeType == 'month' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))),'-',toString(toMonth(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))))   AS dates
        </if>
        <if test="params.timeType == 'quarter' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))),'-',toString(QUARTER(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))))   AS dates
        </if>
        <if test="params.timeType == 'year' ">
            YEAR(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))  AS dates
        </if>
        FROM dwm_vlms_sptb02 dvs
        <where>
            (dvs.CJSDBH, dvs.WAREHOUSE_CREATETIME) in
            (select
            dvs1.CJSDBH,
            max(dvs1.WAREHOUSE_CREATETIME)
            from
            dwm_vlms_sptb02  dvs1
            <where>
                <if test=" params.startTime != null and params.endTime !=null " >
                    and dvs1.SHIPMENT_TIME BETWEEN  #{params.startTime}and #{params.endTime}
                </if>
                <if test=" params.cqwh != null and params.cqwh != '' ">
                    and dvs1.CQWH = #{params.cqwh}          --基地
                </if>
                <if test=" params.czjgsdm != null and params.czjgsdm != '' ">
                    and dvs1.CZJGSDM = #{params.czjgsdm}    --主机品牌
                </if>
            </where>
            group by dvs1.CJSDBH
            )
        </where>
        group by dates ,groupName
    </select>
    <!--按条件查询到货量-->
    <select id="getFINAL_SITE_TIME" parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetBaseBrandTime" resultType="org.jeecg.yqwl.datamiddle.ads.order.entity.ext.ShipmentDTO">
        SELECT
        COUNT(dvs.FINAL_SITE_TIME) as totalNum,
        <choose>
            <when test="params.cqwh != '' and params.czjgsdm == '' ">
                dvs.CUSTOMER_NAME as groupName,
            </when>
            <otherwise>
                dvs.BASE_NAME as groupName,
            </otherwise>
        </choose>

        <if test="params.timeType == 'day' ">
            toDate(fromUnixTimestamp64Milli(dvs.FINAL_SITE_TIME))  AS dates
        </if>
        <if test="params.timeType == 'week' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.FINAL_SITE_TIME))),'-',toString(toWeek(fromUnixTimestamp64Milli(dvs.FINAL_SITE_TIME),9)))   AS dates
        </if>
        <if test="params.timeType == 'month' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.FINAL_SITE_TIME))),'-',toString(toMonth(fromUnixTimestamp64Milli(dvs.FINAL_SITE_TIME))))   AS dates
        </if>
        <if test="params.timeType == 'quarter' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.FINAL_SITE_TIME))),'-',toString(QUARTER(fromUnixTimestamp64Milli(dvs.FINAL_SITE_TIME))))   AS dates
        </if>
        <if test="params.timeType == 'year' ">
            YEAR(fromUnixTimestamp64Milli(dvs.FINAL_SITE_TIME))  AS dates
        </if>
        FROM dwm_vlms_sptb02 dvs
        <where>
            (dvs.CJSDBH, dvs.WAREHOUSE_CREATETIME) in
            (select
            dvs1.CJSDBH,
            max(dvs1.WAREHOUSE_CREATETIME)
            from
            dwm_vlms_sptb02  dvs1
            <where>
                <if test=" params.startTime != null and params.endTime !=null " >
                    and dvs1.FINAL_SITE_TIME BETWEEN  #{params.startTime}and #{params.endTime}
                </if>
                <if test=" params.cqwh != null and params.cqwh != '' ">
                    and dvs1.CQWH = #{params.cqwh}          --基地
                </if>
                <if test=" params.czjgsdm != null and params.czjgsdm != '' ">
                    and dvs1.CZJGSDM = #{params.czjgsdm}    --主机品牌
                </if>
            </where>
            group by dvs1.CJSDBH
            )
        </where>
        group by dates ,groupName

    </select>
    <!--按条件查询到货及时率    todo:后续逻辑优化-->
    <select id="getArrivalRate"
            parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetBaseBrandTime"
            resultType="java.math.BigDecimal">
        SELECT
        count(dvs.CJSDBH) AS totalNum
        FROM
        dwm_vlms_sptb02 dvs
        <where>
            (dvs.CJSDBH,dvs.WAREHOUSE_UPDATETIME) IN (
            SELECT
            CJSDBH,
            MAX(WAREHOUSE_UPDATETIME)
            FROM
            dwm_vlms_sptb02
            <where>
                <if test="  params.startTime != null and params.endTime != null">
                    AND THEORY_SITE_TIME BETWEEN #{params.startTime} AND #{params.endTime}
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    AND THEORY_SITE_TIME <![CDATA[ != ]]> 0
                </if>
                <if test="params.cqwh != null and params.cqwh != ''">
                    AND  CQWH = #{params.cqwh}
                </if>
                <if test="params.czjgsdm != null and params.czjgsdm != '' ">
                    AND CZJGSDM = #{params.czjgsdm}
                </if>
            </where>
            GROUP BY CJSDBH
            )
        </where>
    </select>
    <!--  top10待发量  select count(*) cnf   from dwm_vlms_sptb02 where THEORY_OUT_TIME between '1491485187000' and '1492008443000' group by Date(fromUnixTimestamp64Milli(THEORY_OUT_TIME))  order by cnf desc    -->
    <select id="pendingList"
            resultType="org.jeecg.yqwl.datamiddle.ads.order.entity.ext.ShipmentDTO"
            parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetBaseBrandTime">
        SELECT
        count(dvs.CJSDBH) AS totalNum ,
        <if test="params.timeType == 'day' ">
            toDate(fromUnixTimestamp64Milli(dvs.THEORY_OUT_TIME))  AS dates
        </if>
        <if test="params.timeType == 'week' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.THEORY_OUT_TIME))),'-',toString(toWeek(fromUnixTimestamp64Milli(dvs.THEORY_OUT_TIME),9)))   AS dates
        </if>
        <if test="params.timeType == 'month' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.THEORY_OUT_TIME))),'-',toString(toMonth(fromUnixTimestamp64Milli(dvs.THEORY_OUT_TIME))))   AS dates
        </if>
        <if test="params.timeType =='quarter' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.THEORY_OUT_TIME))),'-',toString(QUARTER(fromUnixTimestamp64Milli(dvs.THEORY_OUT_TIME))))   AS dates
        </if>
        <if test="params.timeType == 'year' ">
            YEAR(fromUnixTimestamp64Milli(dvs.THEORY_OUT_TIME))  AS dates
        </if>
        <choose>
            <when test="params.cqwh !='' and params.czjgsdm ==''">
                ,dvs.CUSTOMER_NAME as groupName
            </when>
            <otherwise>
                ,dvs.BASE_NAME as groupName
            </otherwise>
        </choose>
        FROM
        dwm_vlms_sptb02 dvs
        <where>
            (dvs.CJSDBH,dvs.WAREHOUSE_UPDATETIME) IN (
            SELECT
            v.CJSDBH,
            MAX(v.WAREHOUSE_UPDATETIME)
            FROM
            dwm_vlms_sptb02 v
            <where>

                <if test="  params.startTime != null and params.endTime != null">
                    AND v.THEORY_OUT_TIME BETWEEN #{params.startTime} AND #{params.endTime}
                </if>
                <if test="params.cqwh != null and params.cqwh != ''">
                    AND  v.CQWH = #{params.cqwh}
                </if>
                <if test="params.czjgsdm != null and params.czjgsdm != '' ">
                    AND v.CZJGSDM = #{params.czjgsdm}
                </if>
            </where>
            GROUP BY v.CJSDBH
            )
        </where>
        GROUP BY dates , groupName

    </select>

    <!-- top10在途量    select count(*)  cnf from dwm_vlms_sptb02_test  where  startTime <=  SHIPMENT_TIME and endTime >= FINAL_SITE_TIME  or  FINAL_SITE_TIME = 0L order by cnf desc-->
    <select id="onWayList"
            resultType="org.jeecg.yqwl.datamiddle.ads.order.entity.ext.ShipmentDTO"
            parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetBaseBrandTime">
        SELECT
        count(dvs.CJSDBH) AS totalNum ,
        <if test="params.timeType == 'day' ">
            toDate(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))  AS dates
        </if>
        <if test="params.timeType == 'week' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))),'-',toString(toWeek(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME),9)))   AS dates
        </if>
        <if test="params.timeType == 'month' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))),'-',toString(toMonth(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))))   AS dates
        </if>
        <if test="params.timeType =='quarter' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))),'-',toString(QUARTER(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))))   AS dates
        </if>
        <if test="params.timeType == 'year' ">
              YEAR(fromUnixTimestamp64Milli(dvs.SHIPMENT_TIME))  AS dates
        </if>
        <choose>
            <when test="params.cqwh !='' and params.czjgsdm ==''">
                ,dvs.CUSTOMER_NAME as groupName
            </when>
            <otherwise>
                ,dvs.BASE_NAME as groupName
            </otherwise>
        </choose>
        FROM
        dwm_vlms_sptb02 dvs
        <where>
            (dvs.CJSDBH,dvs.WAREHOUSE_UPDATETIME) IN (
            SELECT
            v.CJSDBH,MAX(v.WAREHOUSE_UPDATETIME)
            FROM
            dwm_vlms_sptb02 v
            <where>
                <if test=" params.startTime != null ">
                    AND  v.SHIPMENT_TIME <![CDATA[ >= ]]> #{params.startTime}
                </if>
                <if test="  params.endTime != null">
                    AND v.FINAL_SITE_TIME <![CDATA[ = ]]> #{params.endTime}
                </if>
                <if test="  params.startTime != null and params.endTime != null ">
                    OR v.FINAL_SITE_TIME <![CDATA[ = ]]> 0
                </if>
                <if test="params.cqwh != null and params.cqwh != ''">
                    AND  v.CQWH = #{params.cqwh}
                </if>
                <if test="params.czjgsdm != null and params.czjgsdm != '' ">
                    AND v.CZJGSDM = #{params.czjgsdm}
                </if>
            </where>
            GROUP BY v.CJSDBH
            )
        </where>
        GROUP BY dates , groupName

    </select>

    <!-- 出库量  select count(*) cnf  from dwm_vlms_sptb02_test where ACTUAL_OUT_TIME between '1491485187000' and '1492008443000' and ACTUAL_OUT_TIME !=0L  -->
    <select id="stockOutList"
            resultType="org.jeecg.yqwl.datamiddle.ads.order.entity.ext.ShipmentDTO"
            parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetBaseBrandTime">
        SELECT
        count(dvs.CJSDBH) AS totalNum ,
        <if test="params.timeType == 'day' ">
            toDate(fromUnixTimestamp64Milli(dvs.ACTUAL_OUT_TIME))  AS dates
        </if>
        <if test="params.timeType == 'week' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.ACTUAL_OUT_TIME))),'-',toString(toWeek(fromUnixTimestamp64Milli(dvs.ACTUAL_OUT_TIME),9)))   AS dates
        </if>
        <if test="params.timeType == 'month' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.ACTUAL_OUT_TIME))),'-',toString(toMonth(fromUnixTimestamp64Milli(dvs.ACTUAL_OUT_TIME))))   AS dates
        </if>
        <if test="params.timeType =='quarter' ">
            CONCAT(toString(YEAR(fromUnixTimestamp64Milli(dvs.ACTUAL_OUT_TIME))),'-',toString(QUARTER(fromUnixTimestamp64Milli(dvs.ACTUAL_OUT_TIME))))   AS dates
        </if>
        <if test="params.timeType == 'year' ">
            YEAR(fromUnixTimestamp64Milli(dvs.ACTUAL_OUT_TIME))  AS dates
        </if>
        <choose>
            <when test="params.cqwh !='' and params.czjgsdm ==''">
                ,dvs.CUSTOMER_NAME as groupName    --品牌   主机公司代码
            </when>
            <otherwise>
                ,dvs.BASE_NAME as groupName   --基地  区位号
            </otherwise>
        </choose>
        FROM
        dwm_vlms_sptb02 dvs
        <where>
            (dvs.CJSDBH,dvs.WAREHOUSE_UPDATETIME) IN (
            SELECT
            v.CJSDBH,
            MAX(v.WAREHOUSE_UPDATETIME)
            FROM
            dwm_vlms_sptb02 v
            <where>
                <if test="  params.startTime != null and params.endTime != null">
                    AND v.ACTUAL_OUT_TIME BETWEEN #{params.startTime} AND #{params.endTime}
                </if>
                <if test="params.cqwh != null and params.cqwh != ''">
                    AND  v.CQWH = #{params.cqwh}
                </if>
                <if test="params.czjgsdm != null and params.czjgsdm != '' ">
                    AND v.CZJGSDM = #{params.czjgsdm}
                </if>
            </where>
            GROUP BY v.CJSDBH
            )
        </where>
        GROUP BY dates , groupName
    </select>
<!--    到货及时样本总量-->
    <select id="getArriveOnTime"
            resultType="java.math.BigDecimal"
            parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetBaseBrandTime">
        SELECT
        count(dvs.CJSDBH) AS totalNum
        FROM
        dwm_vlms_sptb02 dvs
        <where>
            (dvs.CJSDBH,dvs.WAREHOUSE_UPDATETIME) IN (
            SELECT
            CJSDBH,
            MAX(WAREHOUSE_UPDATETIME)
            FROM
            dwm_vlms_sptb02
            <where>
                <if test="  params.startTime != null and params.endTime != null">
                    AND THEORY_SITE_TIME BETWEEN #{params.startTime} AND #{params.endTime}
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    AND FINAL_SITE_TIME <![CDATA[ != ]]> 0
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    AND FINAL_SITE_TIME <![CDATA[ < ]]> THEORY_SITE_TIME
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    OR FINAL_SITE_TIME <![CDATA[ = ]]> 0
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    AND THEORY_SITE_TIME <![CDATA[ > ]]> toUnixTimestamp64Milli(now64(3))
                </if>
                <if test="params.cqwh != null and params.cqwh != ''">
                    AND  CQWH = #{params.cqwh}
                </if>
                <if test="params.czjgsdm != null and params.czjgsdm != '' ">
                    AND CZJGSDM = #{params.czjgsdm}
                </if>
            </where>
            GROUP BY CJSDBH
            )
        </where>
    </select>

<!--    起运及时样本数量-->
    <select id="getTimelyShipment"
            resultType="java.math.BigDecimal"
            parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetBaseBrandTime">
        SELECT
        count(dvs.CJSDBH) AS totalNum
        FROM
        dwm_vlms_sptb02 dvs
        <where>
            (dvs.CJSDBH,dvs.WAREHOUSE_UPDATETIME) IN (
            SELECT
            CJSDBH,
            MAX(WAREHOUSE_UPDATETIME)
            FROM
            dwm_vlms_sptb02
            <where>
                <if test="  params.startTime != null and params.endTime != null">
                    AND THEORY_SHIPMENT_TIME BETWEEN #{params.startTime} AND #{params.endTime}
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    AND SHIPMENT_TIME <![CDATA[ != ]]> 0
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    AND SHIPMENT_TIME <![CDATA[ < ]]> THEORY_SHIPMENT_TIME
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    OR SHIPMENT_TIME <![CDATA[ = ]]> 0
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    AND THEORY_SHIPMENT_TIME <![CDATA[ > ]]> toUnixTimestamp64Milli(now64(3))
                </if>
                <if test="params.cqwh != null and params.cqwh != ''">
                    AND  CQWH = #{params.cqwh}
                </if>
                <if test="params.czjgsdm != null and params.czjgsdm != '' ">
                    AND CZJGSDM = #{params.czjgsdm}
                </if>
            </where>
            GROUP BY CJSDBH
            )
        </where>
    </select>
<!--    起运样本总体-->
    <select id="getTotalShipment"
            resultType="java.math.BigDecimal"
            parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetBaseBrandTime">
        SELECT
        count(dvs.CJSDBH) AS totalNum
        FROM
        dwm_vlms_sptb02 dvs
        <where>
            (dvs.CJSDBH,dvs.WAREHOUSE_UPDATETIME) IN (
            SELECT
            CJSDBH,
            MAX(WAREHOUSE_UPDATETIME)
            FROM
            dwm_vlms_sptb02
            <where>
                <if test="  params.startTime != null and params.endTime != null">
                    AND THEORY_SHIPMENT_TIME BETWEEN #{params.startTime} AND #{params.endTime}
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    AND THEORY_SHIPMENT_TIME <![CDATA[ != ]]> 0
                </if>
                <if test="params.cqwh != null and params.cqwh != ''">
                    AND  CQWH = #{params.cqwh}
                </if>
                <if test="params.czjgsdm != null and params.czjgsdm != '' ">
                    AND CZJGSDM = #{params.czjgsdm}
                </if>
            </where>
            GROUP BY CJSDBH
            )
        </where>


    </select>

<!--    出库准时-->
    <select id="getOnTimeDelivery"
            resultType="java.math.BigDecimal"
            parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetBaseBrandTime">
        SELECT
        count(dvs.CJSDBH) AS totalNum
        FROM
        dwm_vlms_sptb02 dvs
        <where>
            (dvs.CJSDBH,dvs.WAREHOUSE_UPDATETIME) IN (
            SELECT
            CJSDBH,
            MAX(WAREHOUSE_UPDATETIME)
            FROM
            dwm_vlms_sptb02
            <where>
                <if test="  params.startTime != null and params.endTime != null">
                    AND THEORY_OUT_TIME BETWEEN #{params.startTime} AND #{params.endTime}
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    AND ACTUAL_OUT_TIME <![CDATA[ != ]]> 0
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    AND ACTUAL_OUT_TIME <![CDATA[ < ]]> THEORY_OUT_TIME
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    OR ACTUAL_OUT_TIME <![CDATA[ = ]]> 0
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    AND THEORY_OUT_TIME <![CDATA[ > ]]> toUnixTimestamp64Milli(now64(3))
                </if>
                <if test="params.cqwh != null and params.cqwh != ''">
                    AND  CQWH = #{params.cqwh}
                </if>
                <if test="params.czjgsdm != null and params.czjgsdm != '' ">
                    AND CZJGSDM = #{params.czjgsdm}
                </if>
            </where>
            GROUP BY CJSDBH
            )
        </where>
    </select>

<!--    出库总量-->
    <select id="getTotalOutboundQuantity"
            resultType="java.math.BigDecimal"
            parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetBaseBrandTime">
        SELECT
        count(dvs.CJSDBH) AS totalNum
        FROM
        dwm_vlms_sptb02 dvs
        <where>
            (dvs.CJSDBH,dvs.WAREHOUSE_UPDATETIME) IN (
            SELECT
            CJSDBH,
            MAX(WAREHOUSE_UPDATETIME)
            FROM
            dwm_vlms_sptb02
            <where>
                <if test="  params.startTime != null and params.endTime != null">
                    AND THEORY_OUT_TIME BETWEEN #{params.startTime} AND #{params.endTime}
                </if>
                <if test="  params.startTime != null and params.endTime != null">
                    AND THEORY_OUT_TIME <![CDATA[ != ]]> 0
                </if>
                <if test="params.cqwh != null and params.cqwh != ''">
                    AND  CQWH = #{params.cqwh}
                </if>
                <if test="params.czjgsdm != null and params.czjgsdm != '' ">
                    AND CZJGSDM = #{params.czjgsdm}
                </if>
            </where>
            GROUP BY CJSDBH
            )
        </where>
    </select>
    <sql id="where_count_one_to_end">
        <where>
            HOST_COM_CODE = '1'

            <choose>
                <when test="params.vvinList != null or params.selections != null ">
                    AND VVIN IN
                    <foreach collection="params.vvinList" item="value"  index="key" separator="," open="(" close=")">
                        #{value}
                    </foreach>
                </when>
                <otherwise>
                    <if test="params.vvin != null and params.vvin != '' ">
                        AND VVIN = #{params.vvin}
                    </if>
                </otherwise>
            </choose>
            <if test="params.baseName != null and params.baseName != '' ">
                AND BASE_NAME = #{params.baseName}
            </if>
            <if test="params.actualOutTimeStart != null   and params.actualOutTimeStart != 0">
                AND ACTUAL_OUT_TIME <![CDATA[ >= ]]> #{params.actualOutTimeStart}
            </if>
            <if test="params.actualOutTimeEnd != null   and params.actualOutTimeEnd != 0 ">
                AND ACTUAL_OUT_TIME <![CDATA[ <= ]]>  #{params.actualOutTimeEnd}
            </if>
            <if test="params.vehiclePlateIssuedTimeStart != null   and params.vehiclePlateIssuedTimeStart != 0  ">
                AND DDJRQ_R3 <![CDATA[ >= ]]> #{params.vehiclePlateIssuedTimeStart}
            </if>
            <if test="params.vehiclePlateIssuedTimeEnd != null   and params.vehiclePlateIssuedTimeEnd != 0 ">
                AND DDJRQ_R3 <![CDATA[ <= ]]>  #{params.vehiclePlateIssuedTimeEnd}
            </if>
            <if test="params.startCityName != null and params.startCityName != '' ">
                AND START_CITY_NAME = #{params.startCityName}
            </if>
            <if test="params.endCityName != null and params.endCityName != '' ">
                AND END_CITY_NAME = #{params.endCityName}
            </if>
            <if test="params.dtvsdhsjStart != null   and params.dtvsdhsjStart != 0  ">
                AND DTVSDHSJ  <![CDATA[ >= ]]> #{params.dtvsdhsjStart}
            </if>
            <if test="params.dtvsdhsjEnd != null   and params.dtvsdhsjEnd != 0 ">
                AND DTVSDHSJ  <![CDATA[ <= ]]>  #{params.dtvsdhsjEnd}
            </if>
            <if test="params.finalSiteTimeStart != null   and params.finalSiteTimeStart != 0  ">
                AND FINAL_SITE_TIME  <![CDATA[ >= ]]> #{params.finalSiteTimeStart}
            </if>
            <if test="params.finalSiteTimeEnd != null   and params.finalSiteTimeEnd != 0 ">
                AND FINAL_SITE_TIME <![CDATA[ <= ]]>  #{params.finalSiteTimeEnd}
            </if>
            <if test="params.trafficType != null   and params.trafficType != '' ">
                AND TRAFFIC_TYPE =  #{params.trafficType}
            </if>
            <if test="params.cpzdbh != null   and params.cpzdbh != '' ">
                AND CPZDBH =  #{params.cpzdbh}
            </if>
            <if test="params.ccxdlList != null and params.ccxdlList != '' ">
                AND CCXDL IN
                <foreach collection="params.ccxdlList" item="value"  index="key" separator="," open="(" close=")">
                    #{value}
                </foreach>
            </if>
        </where>
    </sql>
<!--    docs查询-->
    <select id="selectDocsList"
            resultType="org.jeecg.yqwl.datamiddle.ads.order.entity.DwmVlmsDocs"
            parameterType = "org.jeecg.yqwl.datamiddle.ads.order.vo.GetQueryCriteria">
        WITH
             A AS ( SELECT count(*) SAME_PLATE_NUM, CPZDBH  FROM dwm_vlms_sptb02 GROUP BY CPZDBH )
        SELECT
            CASE WHEN CPZDBH != '' THEN A.SAME_PLATE_NUM  ELSE 0 END,
           VVIN,HOST_COM_CODE,BASE_NAME,VEHICLE_NAME,START_CITY_NAME,END_CITY_NAME,VDWDM,DEALER_NAME,
           DDJRQ_R3,CPZDBH,ASSIGN_TIME,TRANSPORT_NAME,ACTUAL_OUT_TIME,SHIPMENT_TIME,VJSYDM,A.SAME_PLATE_NUM,
           DTVSDHSJ,FINAL_SITE_TIME
        FROM
            dwm_vlms_sptb02  SPTB02
        LEFT JOIN A ON SPTB02.CPZDBH = A.CPZDBH
        <include refid="where_count_one_to_end" />
        ORDER BY SPTB02.DDJRQ_R3 DESC
        <if test="params.pageNo != 0">
            limit ${params.limitStart}, ${params.limitEnd}
        </if>
    </select>

    <select id="countDocsList"
            resultType="java.lang.Integer">
        SELECT
               COUNT(*)
        FROM
        dwm_vlms_sptb02
        <include refid="where_count_one_to_end" />
    </select>

<!--    docs 车型列表页查询-->
    <select id="selectDocsCcxdlList"
            resultType="org.jeecg.yqwl.datamiddle.ads.order.entity.DwmVlmsDocs"
            parameterType="org.jeecg.yqwl.datamiddle.ads.order.vo.GetQueryCriteria">
        WITH
            A AS ( SELECT count(*) SAME_PLATE_NUM, CPZDBH  FROM dwm_vlms_sptb02 GROUP BY CPZDBH )
        SELECT
            CASE WHEN CPZDBH != '' THEN A.SAME_PLATE_NUM  ELSE 0 END,
            VVIN,HOST_COM_CODE,BASE_NAME,VEHICLE_NAME,START_CITY_NAME,END_CITY_NAME,VDWDM,DEALER_NAME,
            DDJRQ_R3,CPZDBH,ASSIGN_TIME,TRANSPORT_NAME,ACTUAL_OUT_TIME,SHIPMENT_TIME,VJSYDM,A.SAME_PLATE_NUM,
            DTVSDHSJ,FINAL_SITE_TIME
        FROM
            dwm_vlms_sptb02  SPTB02
        LEFT JOIN A ON SPTB02.CPZDBH = A.CPZDBH
        <include refid="where_count_one_to_end" />
        ORDER BY SPTB02.DDJRQ_R3 DESC
        <if test="params.pageNo != 0">
            limit ${params.limitStart}, ${params.limitEnd}
        </if>


    </select>

<!--   docs车型计数 -->
    <select id="countDocsCcxdlList" resultType="java.lang.Integer">
        SELECT
            COUNT(*)
        FROM
        dwm_vlms_sptb02
        <include refid="where_count_one_to_end" />
    </select>

</mapper>
